<!DOCTYPE html>
<head>
</head>
<style>
    #title {
        width: 1040px;
        height:70px;
        font-size: 50px;
        font-weight: bold;
        text-align: center;
        padding-top: 10px;
        border-bottom: 1px solid black;
    }
    #intro {
        padding-top: 20px;
        width: 1040px;
        height: 140px;
    }
    #chartTitle {
        width: 1040px;
        height: 40px;
        font-size: 20px;
        font-weight: bold;
        padding-top: 10px;
    }
    #chartDescription{
        width: 1040px;

    }
    #chartInstructionTitle{
        width: 1040px;
        font-size: 20px;
        font-weight: bold;
        padding-top: 10px;
    }
    #chartInstruction{
        width: 1040px;
        border-bottom: 1px solid black;
        padding-top: 10px;
        padding-bottom: 20px;
    }
    #monthDropdown {
        position: relative;
        top: 60px;
        left: 80px;
        width: 200px;
    }
    #stateDropdown {
        position: relative;
        top: 60px;
        left: 80px;
        width: 200px;
    }
    #monthDropdown1 {
        position: relative;
        top: 60px;
        left: 100px;
        width: 200px;
    }
    #stateDropdown1 {
        position: relative;
        top: 60px;
        left: 80px;
        width: 200px;
    }

    #navigation {
        padding-top: 20px;
    }

    #navigation button {
        position: relative;
        left: 80px;
        width: 200px;
        height: 40px;
        background-color: #b0b0b0;
        color: black;
        font-size: 15px;
        border: none;
        cursor: pointer;
        border-radius: 10px;
    }
    #navigation button:hover {
        position: relative;
        left: 80px;
        width: 200px;
        height: 40px;
        background-color: steelblue;
        color: white;
        font-size: 15px;
        border: none;
        cursor: pointer;
        border-radius: 10px;
    }
    #navigation .selected {
        position: relative;
        left: 80px;
        width: 200px;
        height: 40px;
        background-color: steelblue;
        color: white;
        font-size: 15px;
        border: none;
        cursor: pointer;
        border-radius: 10px;
    }
</style>
<div id="title">
US Corona Virus cases in 2020
</div>
<div id="intro">
    The below visualizations of USA COVID-19 cases in 2020 offers a comprehensive and interactive tool for understanding the progression of the pandemic. By examining data from multiple perspectives, we can gain valuable insights into the varying impact of the virus across states and months. The key dates, including lockdown initiation (approximation), nationwide death reports, and lockdown conclusion (approximation), serve as crucial milestones in the narrative, providing context to the data analysis. 
    <p>Data source: <a href="https://covidtracking.com/data/download">https://covidtracking.com/data/download</a></p>
</div>
<div id="chartTitle">US COVID-19 Cases in 2020</div>
<div id="chartDescription"></div>
<div id="chartInstructionTitle">Instructions:</div>
<div id="chartInstruction"></div>
<div id="navigation">
    <button id="fullYearButton" class="selected">Full Year</button>
    <button id="byMonthButton">By Month</button>
    <button id="byStateButton">By State</button>
    <button id="byMonthStateButton">By State and Month</button>
</div>
<div id="fullYearArea">
    <div id="fullYearChart" class="center"></div>
    <div id="fullYearLowerChart" class="center"></div>
</div>
<div id="byMonthArea">
    <select id="monthDropdown" >
    </select>
    <div id="byMonthChart" class="center"></div>
</div>
<div id="byStateArea">
    <select id="stateDropdown" >
    </select>
    <div id="byStateChart" class="center"></div>
</div>
<div id="byMonthStateArea">
    <select id="stateDropdown1" >
    </select>
    <select id="monthDropdown1" >
    </select>
    <div id="byMonthStateChart" class="center"></div>
</div>


<script src="./d3.v7.min.js"></script>
<script type="module">


// Declare the chart dimensions and margins.
const width = 1040;
const height = 600;
const marginTop = 100;
const marginRight = 220;
const marginBottom = 160;
const marginLeft = 80;
const all_states = ['Alaska', 'Alabama', 'Arkansas', 'American Samoa', 'Arizona',
       'California', 'Colorado', 'Connecticut', 'District of Columbia',
       'Delaware', 'Florida', 'Georgia', 'Guam', 'Hawaii', 'Iowa',
       'Idaho', 'Illinois', 'Indiana', 'Kansas', 'Kentucky', 'Louisiana',
       'Massachusetts', 'Maryland', 'Maine', 'Michigan', 'Minnesota',
       'Missouri', 'Northern Mariana Islands', 'Mississippi', 'Montana',
       'North Carolina', 'North Dakota', 'Nebraska', 'New Hampshire',
       'New Jersey', 'New Mexico', 'Nevada', 'New York', 'Ohio',
       'Oklahoma', 'Oregon', 'Pennsylvania', 'Puerto Rico',
       'Rhode Island', 'South Carolina', 'South Dakota', 'Tennessee',
       'Texas', 'Utah', 'Virginia', 'Virgin Islands', 'Vermont',
       'Washington', 'Wisconsin', 'West Virginia', 'Wyoming'];
const months = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", 
        "Nov", "Dec"];

// const data_states = [
//     {state_name: "Alaska", month_name: "Jan", death: 0, hospitalized: 0, positive: 1},
//     {state_name: "Alaska",month_name: "Feb", death: 1, hospitalized: 2, positive: 2},
//     {state_name: "Alaska",month_name: "Mar", death: 2, hospitalized: 20, positive: 40},
//     {state_name: "Alaska",month_name: "Apr", death: 3, hospitalized: 40, positive: 150},
//     {state_name: "Alaska",month_name: "May", death: 4, hospitalized: 50, positive: 250},
//     {state_name: "Alaska",month_name: "Jun", death: 5, hospitalized: 60, positive: 300},
//     {state_name: "Alaska",month_name: "Jul", death: 6, hospitalized: 70, positive: 350},
//     {state_name: "Alaska",month_name: "Aug", death: 7, hospitalized: 80, positive: 450},
//     {state_name: "Alaska",month_name: "Sep", death: 8.12312312312312, hospitalized: 70, positive: 550},
//     {state_name: "Alaska",month_name: "Oct", death: 9, hospitalized: 60, positive: 550},
//     {state_name: "Alaska",month_name: "Nov", death: 10, hospitalized: 80, positive: 550},
//     {state_name: "Alaska",month_name: "Dec", death: 11, hospitalized: 70, positive: 550},
//     {state_name: "Texas", month_name: "Jan", death: 0, hospitalized: 0, positive: 0},
//     {state_name: "Texas",month_name: "Feb", death: 1, hospitalized: 2, positive: 2},
//     {state_name: "Texas",month_name: "Mar", death: 2, hospitalized: 20, positive: 40},
//     {state_name: "Texas",month_name: "Apr", death: 3, hospitalized: 40, positive: 150},
//     {state_name: "Texas",month_name: "May", death: 4, hospitalized: 42, positive: 421},
//     {state_name: "Texas",month_name: "Jun", death: 5, hospitalized: 60, positive: 300},
//     {state_name: "Texas",month_name: "Jul", death: 6, hospitalized: 22, positive: 120},
//     {state_name: "Texas",month_name: "Aug", death: 7, hospitalized: 80, positive: 450},
//     {state_name: "Texas",month_name: "Sep", death: 8.12312312312312, hospitalized: 70, positive: 550},
//     {state_name: "Texas",month_name: "Oct", death: 9, hospitalized: 60, positive: 550},
//     {state_name: "Texas",month_name: "Nov", death: 10, hospitalized: 80, positive: 600},
//     {state_name: "Texas",month_name: "Dec", death: 111, hospitalized: 70, positive: 550}
// ]

// const data_all = [
//     {month_name: "Jan", death: 0, hospitalized: 0, positive: 0},
//     {month_name: "Feb", death: 1, hospitalized: 2, positive: 2},
//     {month_name: "Mar", death: 2, hospitalized: 4, positive: 40},
//     {month_name: "Apr", death: 3, hospitalized: 6, positive: 150},
//     {month_name: "May", death: 4, hospitalized: 2, positive: 250},
//     {month_name: "Jun", death: 5, hospitalized: 17, positive: 300},
//     {month_name: "Jul", death: 6, hospitalized: 20, positive: 350},
//     {month_name: "Aug", death: 7, hospitalized: 12, positive: 450},
//     {month_name: "Sep", death: 8.12312312312312, hospitalized: 16, positive: 550},
//     {month_name: "Oct", death: 9, hospitalized: 19, positive: 550},
//     {month_name: "Nov", death: 10, hospitalized: 15, positive: 550},
//     {month_name: "Dec", death: 11, hospitalized: 2, positive: 550}
// ]


const data_states = await d3.csv("./uscovid19_2020_states.csv");

//Divide all months number by 1 million
data_states.forEach(function(d) {
    d.death = d.death / 1000000;
    d.hospitalized = d.hospitalized / 1000000;
    d.positive = d.positive / 1000000;
});

const data_all = await d3.csv("./uscovid19_2020_all.csv");

//Divide all months number by 1 million
data_all.forEach(function(d) {
    d.death = d.death / 1000000;
    d.hospitalized = d.hospitalized / 1000000;
    d.positive = d.positive / 1000000;
});

const fullYearTitle = "US COVID-19 Cases Full Year Trend";
const fullYearDescription = "The Full Year chart displays the progression of COVID-19 cases over time, focusing on three critical categories: positive cases, hospitalized cases, and death cases. The X-axis represents months, while the Y-axis indicates the number of cases in millions. This line chart allows us to observe the changing patterns and trends across the year, providing insights into the overall impact of the virus nationwide. The second chart displays only death and hospitalized cases to provide a better perspective without the positive cases.";
const fullYearInstruction = "Hover over the data points to view the number of cases for each category. Click on the data points to drill down to the By Month chart.";

const byMonthTitle = "US COVID-19 Cases by Month";
const byMonthDescription = "The By Month chart displays the progression of COVID-19 cases over time, focusing on three critical categories: positive cases, hospitalized cases, and death cases. The X-axis represents the US states or territories, while the Y-axis indicates the number of cases in millions. The number of case for each state are sorted in ascending order.";
const byMonthInstruction = "Select month using the dropdown. Hover over the data points to view the number of cases for each category. Click on the data points to drill down to the By State chart.";

const byStateTitle = "US COVID-19 Cases by State";
const byStateDescription = "The By State chart displays the progression of COVID-19 cases over time, focusing on three critical categories: positive cases, hospitalized cases, and death cases. The X-axis represents months, while the Y-axis indicates the number of cases in millions.";
const byStateInstruction = "Select state using the dropdown. Hover over the data points to view the number of cases for each category. Click on the data points to drill down to the By State and Month chart.";

const byMonthStateTitle = "US COVID-19 Cases by State and Month";
const byMonthStateDescription = "The By State and Month chart is represented as a pie chart, providing a more granular view of the three case categories for each state in a selected month. By using the dual drop-down menus, users can investigate the percentage distribution of positive, hospitalized, and death cases within a state for a specific month. This chart enables a detailed breakdown, allowing users to assess the severity of the pandemic in different states during different periods.";
const byMonthStateInstruction = "Select state and month using the dropdowns. Hover over the pie chart to view the percentage of cases for each category.";

// On change month_filter, update the chart
d3.select("#monthDropdown")
        .selectAll("option")
        .data(months)
        .enter()
        .append("option")
        .attr("value", d => d)
        .text(d => d);
d3.select("#monthDropdown").on("change", function () {
    const month_filter = d3.select(this).property("value");
    console.log(`selected month: `,month_filter);
    displayMonthChart(month_filter);
});

// On change state_filter, update the chart
d3.select("#stateDropdown")
        .selectAll("option")
        .data(all_states)
        .enter()
        .append("option")
        .attr("value", d => d)
        .text(d => d);
d3.select("#stateDropdown").on("change", function () {
    const state_filter = d3.select(this).property("value");
    console.log(`selected state: `,state_filter);
    displayStateChart(state_filter);
});

d3.select("#monthDropdown1")
        .selectAll("option")
        .data(months)
        .enter()
        .append("option")
        .attr("value", d => d)
        .text(d => d);
d3.select("#stateDropdown1").on("change", function () {
    const state_filter = d3.select(this).property("value");
    const month_filter = d3.select("#monthDropdown1").property("value");
    displayMonthStateChart(month_filter, state_filter);
})
d3.select("#stateDropdown1")
        .selectAll("option")
        .data(all_states)
        .enter()
        .append("option")
        .attr("value", d => d)
        .text(d => d);
d3.select("#monthDropdown1").on("change", function () {
    const month_filter = d3.select(this).property("value");
    const state_filter = d3.select("#stateDropdown1").property("value");
    displayMonthStateChart(month_filter, state_filter);
})



d3.select("#fullYearButton").on("click", function() {
    d3.select("#fullYearArea").style("display", "block");
    d3.select("#byMonthArea").style("display", "none");
    d3.select("#byStateArea").style("display", "none");
    d3.select("#byMonthStateArea").style("display", "none");

    d3.select("#byStateButton").attr("class", "");
    d3.select("#fullYearButton").attr("class", "selected");
    d3.select("#byMonthButton").attr("class", "");
    d3.select("#byMonthStateButton").attr("class", "");

    d3.select("#chartTitle").text(fullYearTitle);
    d3.select("#chartDescription").text(fullYearDescription);
    d3.select("#chartInstruction").text(fullYearInstruction);

})

d3.select("#byMonthButton").on("click", function() {
    d3.select("#fullYearArea").style("display", "none");
    d3.select("#byMonthArea").style("display", "block");
    d3.select("#byStateArea").style("display", "none");
    d3.select("#byMonthStateArea").style("display", "none");

    d3.select("#fullYearButton").attr("class", "");
    d3.select("#byMonthButton").attr("class", "selected");
    d3.select("#byStateButton").attr("class", "");
    d3.select("#byMonthStateButton").attr("class", "");

    d3.select("#chartTitle").text(byMonthTitle);
    d3.select("#chartDescription").text(byMonthDescription);
    d3.select("#chartInstruction").text(byMonthInstruction);
})


d3.select("#byStateButton").on("click", function () {
    d3.select("#fullYearArea").style("display", "none");
    d3.select("#byMonthArea").style("display", "none");
    d3.select("#byStateArea").style("display", "block");
    d3.select("#byMonthStateArea").style("display", "none");

    d3.select("#byStateButton").attr("class", "selected");
    d3.select("#fullYearButton").attr("class", "");
    d3.select("#byMonthButton").attr("class", "");
    d3.select("#byMonthStateButton").attr("class", "");

    d3.select("#chartTitle").text(byStateTitle);
    d3.select("#chartDescription").text(byStateDescription);
    d3.select("#chartInstruction").text(byStateInstruction);

});

d3.select("#byMonthStateButton").on("click", function () {
    d3.select("#fullYearArea").style("display", "none");
    d3.select("#byMonthArea").style("display", "none");
    d3.select("#byStateArea").style("display", "none");
    d3.select("#byMonthStateArea").style("display", "block");

    d3.select("#byStateButton").attr("class", "none");
    d3.select("#fullYearButton").attr("class", "");
    d3.select("#byMonthButton").attr("class", "");
    d3.select("#byMonthStateButton").attr("class", "selected");

    d3.select("#chartTitle").text(byMonthStateTitle);
    d3.select("#chartDescription").text(byMonthStateDescription);
    d3.select("#chartInstruction").text(byMonthStateInstruction);
});


// Onload display the charts
displayFullYearChart();
displayFullYearLowerChart();
displayMonthChart();
displayStateChart("Alaska");
displayMonthStateChart();

function monthDrillDown(month_name) {
    d3.select("#fullYearArea").style("display", "none");
    d3.select("#byMonthArea").style("display", "block");
    d3.select("#byStateArea").style("display", "none");

    d3.select("#fullYearButton").attr("class", "");
    d3.select("#byMonthButton").attr("class", "selected");
    d3.select("#byStateButton").attr("class", "");

    // Change the monthDropdown to the selected month
    d3.select("#monthDropdown").property("value", month_name);
    // Display the chart for the selected month

    d3.select("#chartTitle").text(byMonthTitle);
    d3.select("#chartDescription").text(byMonthDescription);
    d3.select("#chartInstruction").text(byMonthInstruction);

    displayMonthChart(month_name);   
}

function stateDrillDown(state_name) {
    d3.select("#fullYearArea").style("display", "none");
    d3.select("#byMonthArea").style("display", "none");
    d3.select("#byStateArea").style("display", "block");
    d3.select("#byStateButton").attr("class", "selected");
    d3.select("#fullYearButton").attr("class", "");
    d3.select("#byMonthButton").attr("class", "");

    // Change the stateDropdown to the selected state
    d3.select("#stateDropdown").property("value", state_name);
    // Display the chart for the selected state

    d3.select("#chartTitle").text(byStateTitle);
    d3.select("#chartDescription").text(byStateDescription);
    d3.select("#chartInstruction").text(byStateInstruction);

    displayStateChart(state_name);
}

function monthStateDrillDown(month_name, state_name){
    d3.select("#fullYearArea").style("display", "none");
    d3.select("#byMonthArea").style("display", "none");
    d3.select("#byStateArea").style("display", "none");
    d3.select("#byMonthStateArea").style("display", "block");

    d3.select("#byStateButton").attr("class", "none");
    d3.select("#fullYearButton").attr("class", "");
    d3.select("#byMonthButton").attr("class", "");
    d3.select("#byMonthStateButton").attr("class", "selected");

    // Change the stateDropdown to the selected state
    d3.select("#stateDropdown1").property("value", state_name);
    // Change the monthDropdown to the selected month
    d3.select("#monthDropdown1").property("value", month_name);

    d3.select("#chartTitle").text(byMonthStateTitle);
    d3.select("#chartDescription").text(byMonthStateDescription);
    d3.select("#chartInstruction").text(byMonthStateInstruction);

    // Display the chart for the selected state
    displayMonthStateChart(month_name, state_name);
}

function displayFullYearChart () {
    d3.select("#chartTitle").text(fullYearTitle);
    d3.select("#chartDescription").text(fullYearDescription);
    d3.select("#chartInstruction").text(fullYearInstruction);

    d3.select("#fullYearArea").style("display", "block");
    d3.select("#byMonthArea").style("display", "none");
    d3.select("#byStateArea").style("display", "none");
    d3.select("#byMonthStateArea").style("display", "none");

    // first empty the fullYearChart
    d3.select("#fullYearChart").selectAll("*").remove();
    console.log(data_all);

    // Declare the x (horizontal position) scale.
    const x = d3.scaleBand()
        .domain(months)
        .range([marginLeft, width - marginRight]);
    const y_max = 600; // Milions
    // Declare the y (vertical position) scale.
    const y = d3.scaleLinear()
        .domain([0, y_max])
        .range([height - marginBottom, marginTop]);

    // Create the SVG container.
    const svg = d3.create("svg")
        .attr("width", width)
        .attr("height", height);

    // Add the x-axis.
    svg.append("g")
        .attr("transform", `translate(0,${height - marginBottom})`)
        .call(d3.axisBottom(x));
    // Add x-axis label
    svg.append("text")
        .attr("class", "x label")
        .attr("text-anchor", "end")
        .attr("x", (width - marginRight)/2 + 50)
        .attr("y", height - marginBottom + 40)
        .attr("font-size", "15px")
        .text("Month");

    // Add the y-axis.
    svg.append("g")
        .attr("transform", `translate(${marginLeft},0)`)
        .call(d3.axisLeft(y));
    // Add y-axis label
    svg.append("text")
        .attr("class", "y label")
        .attr("text-anchor", "end")
        .attr("x", -(height/3))
        .attr("y", marginLeft - 50)
        .attr("font-size", "15px")
        .attr("transform", "rotate(-90)")
        .text("Number of cases (millions)");

    // Add line for death
    svg.append("path")
        .datum(data_all)
        .attr("fill", "none")
        .attr("stroke", "red")
        .attr("stroke-width", 1.5)
        .attr("d", d3.line()
            .x(function(d) { return x(d.month_name) + x.bandwidth()/2 })
            .y(function(d) { return y(d.death) })
        );
    // Add circle for death
    svg.selectAll("dot")
        .data(data_all)
        .enter()
        .append("circle")
        .attr("cx", function(d) { return x(d.month_name) + x.bandwidth()/2 })
        .attr("cy", function(d) { return y(d.death) })
        .attr("r", 6)
        .attr("fill", "red")
                // Add tooltip when mouse over any circle
        // Tool tip is the sum of positive, hospitalized and death
        // Tool tip is positioned right on top of the circle
        .on("mouseover", function(event, d){
            // Change pointer to hand
            d3.select(this).style("cursor", "pointer");
            svg.append("rect")
                .attr("height", 75)
                .attr("width",145)
                .attr("id", "tooltip")
                .attr("x", x(d.month_name) +40)
                .attr("y", y(d.death) - 30)
                .attr("fill", "white")
                .attr("stroke", "black")
                .attr("stroke-width", 1);
            svg.append("text")
                .attr("class", "tooltiptext")
                .attr("fill", "black")
                .attr("font-family", "sans-serif")
                .attr("font-size", "10px")
                .attr("font-weight", "bold")
                .attr("x", x(d.month_name) + 45)
                .attr("y", (y(d.death) -10))
                .text(`Month: ${d.month_name}`);
            svg.append("text")
                .attr("class", "tooltiptext")
                .attr("fill", "steelblue")
                .attr("font-family", "sans-serif")
                .attr("font-size", "10px")
                .attr("font-weight", "bold")
                .attr("x", x(d.month_name) + 45)
                .attr("y", (y(d.death )+5))
                .text(`Positive: ${d.positive.toFixed(2)} millions`);
            svg.append("text")
                .attr("class", "tooltiptext")
                .attr("fill", "orange")
                .attr("font-family", "sans-serif")
                .attr("font-size", "10px")
                .attr("font-weight", "bold")
                .attr("x", x(d.month_name) + 45)
                .attr("y", (y(d.death)+20))
                .text(`Hospitalized: ${d.hospitalized.toFixed(2)} millions`);
            svg.append("text")
                .attr("class", "tooltiptext")
                .attr("fill", "red")
                .attr("font-family", "sans-serif")
                .attr("font-size", "10px")
                .attr("font-weight", "bold")
                .attr("x", x(d.month_name) + 45)
                .attr("y", (y(d.death)+35))
                .text(`Death: ${d.death.toFixed(2)} millions`);
        }).on("mouseout", function(event, d) {
            d3.select("#tooltip").remove();
            d3.selectAll(".tooltiptext").remove();
        })
        // On click, drill down to the month chart
        .on("click", function(event, d) {
            monthDrillDown(d.month_name);
        });
    
    // Add line for hospitalized
    svg.append("path")
        .datum(data_all)
        .attr("fill", "none")
        .attr("stroke", "orange")
        .attr("stroke-width", 1.5)
        .attr("d", d3.line()
            .x(function(d) { return x(d.month_name) + x.bandwidth()/2 })
            .y(function(d) { return y(d.hospitalized) })
        );
    // Add circle for hospitalized
    svg.selectAll("dot")
        .data(data_all)
        .enter()
        .append("circle")
        .attr("cx", function(d) { return x(d.month_name) + x.bandwidth()/2 })
        .attr("cy", function(d) { return y(d.hospitalized) })
        .attr("r", 6)
        .attr("fill", "orange")
        // Add tooltip when mouse over any circle
        // Tool tip is the sum of positive, hospitalized and death
        // Tool tip is positioned right on top of the circle
        .on("mouseover", function(event, d){
            // Change pointer to hand
            d3.select(this).style("cursor", "pointer");
            svg.append("rect")
                .attr("height", 75)
                .attr("width",145)
                .attr("id", "tooltip")
                .attr("x", x(d.month_name) +40)
                .attr("y", y(d.death + d.hospitalized) - 30)
                .attr("fill", "white")
                .attr("stroke", "black")
                .attr("stroke-width", 1);
            svg.append("text")
                .attr("class", "tooltiptext")
                .attr("fill", "black")
                .attr("font-family", "sans-serif")
                .attr("font-size", "10px")
                .attr("font-weight", "bold")
                .attr("x", x(d.month_name) + 45)
                .attr("y", (y(d.death + d.hospitalized) -10))
                .text(`Month: ${d.month_name}`);
            svg.append("text")
                .attr("class", "tooltiptext")
                .attr("fill", "steelblue")
                .attr("font-family", "sans-serif")
                .attr("font-size", "10px")
                .attr("font-weight", "bold")
                .attr("x", x(d.month_name) + 45)
                .attr("y", (y(d.death + d.hospitalized)+5))
                .text(`Positive: ${d.positive.toFixed(2)} millions`);
            svg.append("text")
                .attr("class", "tooltiptext")
                .attr("fill", "orange")
                .attr("font-family", "sans-serif")
                .attr("font-size", "10px")
                .attr("font-weight", "bold")
                .attr("x", x(d.month_name) + 45)
                .attr("y", (y(d.death + d.hospitalized)+20))
                .text(`Hospitalized: ${d.hospitalized.toFixed(2)} millions`);
            svg.append("text")
                .attr("class", "tooltiptext")
                .attr("fill", "red")
                .attr("font-family", "sans-serif")
                .attr("font-size", "10px")
                .attr("font-weight", "bold")
                .attr("x", x(d.month_name) + 45)
                .attr("y", (y(d.death + d.hospitalized)+35))
                .text(`Death: ${d.death.toFixed(2)} millions`);
        }).on("mouseout", function(event, d) {
            d3.select("#tooltip").remove();
            d3.selectAll(".tooltiptext").remove();
        })
         // On click, drill down to the month chart
         .on("click", function(event, d) {
            monthDrillDown(d.month_name);
        });

    // Add line for positive
    svg.append("path")
        .datum(data_all)
        .attr("fill", "none")
        .attr("stroke", "steelblue")
        .attr("stroke-width", 1.5)
        .attr("d", d3.line()
            .x(function(d) { return x(d.month_name) + x.bandwidth()/2 })
            .y(function(d) { return y(d.positive) })
        )
    // Add circle for positive
    svg.selectAll("dot")
        .data(data_all)
        .enter()
        .append("circle")
        .attr("cx", function(d) { return x(d.month_name) + x.bandwidth()/2 })
        .attr("cy", function(d) { return y(d.positive) })
        .attr("r", 6)
        .attr("fill", "steelblue")
        // Add tooltip when mouse over any circle
        // Tool tip is the sum of positive, hospitalized and death
        // Tool tip is positioned right on top of the circle
        .on("mouseover", function(event, d){
            // Change pointer to hand
            d3.select(this).style("cursor", "pointer");
            svg.append("rect")
                .attr("height", 75)
                .attr("width",145)
                .attr("id", "tooltip")
                .attr("x", x(d.month_name) +40)
                .attr("y", y(d.death + d.hospitalized + d.positive))
                .attr("fill", "white")
                .attr("stroke", "black")
                .attr("stroke-width", 1);
            svg.append("text")
                .attr("class", "tooltiptext")
                .attr("fill", "black")
                .attr("font-family", "sans-serif")
                .attr("font-size", "10px")
                .attr("font-weight", "bold")
                .attr("x", x(d.month_name) + 45)
                .attr("y", (y(d.death + d.hospitalized + d.positive)+20))
                .text(`Month: ${d.month_name}`);
            svg.append("text")
                .attr("class", "tooltiptext")
                .attr("fill", "steelblue")
                .attr("font-family", "sans-serif")
                .attr("font-size", "10px")
                .attr("font-weight", "bold")
                .attr("x", x(d.month_name) + 45)
                .attr("y", (y(d.death + d.hospitalized + d.positive)+35))
                .text(`Positive: ${d.positive.toFixed(2)} millions`);
            svg.append("text")
                .attr("class", "tooltiptext")
                .attr("fill", "orange")
                .attr("font-family", "sans-serif")
                .attr("font-size", "10px")
                .attr("font-weight", "bold")
                .attr("x", x(d.month_name) + 45)
                .attr("y", (y(d.death + d.hospitalized + d.positive)+50))
                .text(`Hospitalized: ${d.hospitalized.toFixed(2)} millions`);
            svg.append("text")
                .attr("class", "tooltiptext")
                .attr("fill", "red")
                .attr("font-family", "sans-serif")
                .attr("font-size", "10px")
                .attr("font-weight", "bold")
                .attr("x", x(d.month_name) + 45)
                .attr("y", (y(d.death + d.hospitalized + d.positive)+65))
                .text(`Death: ${d.death.toFixed(2)} millions`);
        }).on("mouseout", function(event, d) {
            d3.select("#tooltip").remove();
            d3.selectAll(".tooltiptext").remove();
        })
         // On click, drill down to the month chart
         .on("click", function(event, d) {
            monthDrillDown(d.month_name);
        });
    // Add annotation
    // Add an Annotation in between April and May, which is a vertical line
    // On top of the line is a horizontal line
    // On top of the horizontal line is a text
    svg.append("line")
        .attr("x1", x("Mar") + x.bandwidth()/2)
        .attr("y1", y(0))
        .attr("x2",  x("Mar") + x.bandwidth()/2)
        .attr("y2", y(550))
        .attr("stroke-width", 1)
        .attr("stroke", "black");
    svg.append("line")
        .attr("x1",  x("Mar") + x.bandwidth()/2)
        .attr("y1", y(550))
        .attr("x2", x("May") + x.bandwidth()/2 )
        .attr("y2", y(550))
        .attr("stroke-width", 1)
        .attr("stroke", "black");
    svg.append("text")
        .attr("fill", "black")
        .attr("font-family", "sans-serif")
        .attr("font-size", "12px")
        .attr("font-weight", "bold")
        .attr("x",  x("Mar") + x.bandwidth()/2 + 5)
        .attr("y", y(550) - 10)
        .text("Lock-down started");

    svg.append("line")
        .attr("x1", x("May"))
        .attr("y1", y(0))
        .attr("x2",  x("May"))
        .attr("y2", y(500))
        .attr("stroke-width", 1)
        .attr("stroke", "black");
    svg.append("line")
        .attr("x1", x("May"))
        .attr("y1", y(500))
        .attr("x2", x("Sep") + x.bandwidth()/2 )
        .attr("y2", y(500))
        .attr("stroke-width", 1)
        .attr("stroke", "black");
    svg.append("text")
        .attr("fill", "black")
        .attr("font-family", "sans-serif")
        .attr("font-size", "12px")
        .attr("font-weight", "bold")
        .attr("x",  x("May") + 5)
        .attr("y", y(500) - 10)
        .text("All 50 US states reported death cases by April 15");
    
    svg.append("line")
        .attr("x1", x("Jul") + x.bandwidth()/2)
        .attr("y1", y(0))
        .attr("x2", x("Jul") + x.bandwidth()/2)
        .attr("y2", y(450))
        .attr("stroke-width", 1)
        .attr("stroke", "black");
    svg.append("line")
        .attr("x1", x("Jul") + x.bandwidth()/2)
        .attr("y1", y(450))
        .attr("x2", x("Sep") + x.bandwidth()/2 )
        .attr("y2", y(450))
        .attr("stroke-width", 1)
        .attr("stroke", "black");
    svg.append("text")
        .attr("fill", "black")
        .attr("font-family", "sans-serif")
        .attr("font-size", "12px")
        .attr("font-weight", "bold")
        .attr("x",   x("Jul") + x.bandwidth()/2 + 5)
        .attr("y", y(450) - 10)
        .text("Lock-down ended");

    // Add legend
    svg.append("circle")
        .attr("r", 6)
        .attr("cx", width - marginRight + 20)
        .attr("cy", marginTop + 20)
        .attr("fill", "red");
    svg.append("text")
        .attr("fill", "black")
        .attr("font-family", "sans-serif")
        .attr("font-size", "10px")
        .attr("font-weight", "bold")
        .attr("x", width - marginRight + 40)
        .attr("y", marginTop + 23)
        .text("Deaths");
    svg.append("circle")
        .attr("r", 6)
        .attr("cx", width - marginRight + 20)
        .attr("cy", marginTop + 40)
        .attr("fill", "orange");
    svg.append("text")
        .attr("fill", "black")
        .attr("font-family", "sans-serif")
        .attr("font-size", "10px")
        .attr("font-weight", "bold")
        .attr("x", width - marginRight + 40)
        .attr("y", marginTop + 43)
        .text("Hospitalized");
    svg.append("circle")
        .attr("r", 6)
        .attr("cx", width - marginRight + 20)
        .attr("cy", marginTop + 60)
        .attr("fill", "steelblue");
    svg.append("text")
        .attr("fill", "black")
        .attr("font-family", "sans-serif")
        .attr("font-size", "10px")
        .attr("font-weight", "bold")
        .attr("x", width - marginRight + 40)
        .attr("y", marginTop + 63)
        .text("Positive");
    
    
    fullYearChart.append(svg.node());
};

function displayFullYearLowerChart () {
    d3.select("#fullYearArea").style("display", "block");
    d3.select("#byMonthArea").style("display", "none");
    d3.select("#byStateArea").style("display", "none");
    d3.select("#byMonthStateArea").style("display", "none");

    // first empty the fullYearChart
    d3.select("#fullYearLowerChart").selectAll("*").remove();
    const marginTop = 10;

    // Declare the x (horizontal position) scale.
    const x = d3.scaleBand()
        .domain(months)
        .range([marginLeft, width - marginRight]);
    const y_max = 30; // Milions
    // Declare the y (vertical position) scale.
    const y = d3.scaleLinear()
        .domain([0, y_max])
        .range([height - marginBottom, marginTop]);

    // Create the SVG container.
    const svg = d3.create("svg")
        .attr("width", width)
        .attr("height", height);

    // Add the x-axis.
    svg.append("g")
        .attr("transform", `translate(0,${height - marginBottom})`)
        .call(d3.axisBottom(x));
    // Add x-axis label
    svg.append("text")
        .attr("class", "x label")
        .attr("text-anchor", "end")
        .attr("x", (width - marginRight)/2 + 50)
        .attr("y", height - marginBottom + 40)
        .attr("font-size", "15px")
        .text("Month");

    // Add the y-axis.
    svg.append("g")
        .attr("transform", `translate(${marginLeft},0)`)
        .call(d3.axisLeft(y));
    // Add y-axis label
    svg.append("text")
        .attr("class", "y label")
        .attr("text-anchor", "end")
        .attr("x", -(height/3))
        .attr("y", marginLeft - 50)
        .attr("font-size", "15px")
        .attr("transform", "rotate(-90)")
        .text("Number of cases (millions)");

    // Add line for death
    svg.append("path")
        .datum(data_all)
        .attr("fill", "none")
        .attr("stroke", "red")
        .attr("stroke-width", 1.5)
        .attr("d", d3.line()
            .x(function(d) { return x(d.month_name) + x.bandwidth()/2 })
            .y(function(d) { return y(d.death) })
        );
    // Add circle for death
    svg.selectAll("dot")
        .data(data_all)
        .enter()
        .append("circle")
        .attr("cx", function(d) { return x(d.month_name) + x.bandwidth()/2 })
        .attr("cy", function(d) { return y(d.death) })
        .attr("r", 6)
        .attr("fill", "red")
                // Add tooltip when mouse over any circle
        // Tool tip is the sum of positive, hospitalized and death
        // Tool tip is positioned right on top of the circle
        .on("mouseover", function(event, d){
            // Change pointer to hand
            d3.select(this).style("cursor", "pointer");
            svg.append("rect")
                .attr("height", 75)
                .attr("width",145)
                .attr("id", "tooltip")
                .attr("x", x(d.month_name) +40)
                .attr("y", y(d.death) - 30)
                .attr("fill", "white")
                .attr("stroke", "black")
                .attr("stroke-width", 1);
            svg.append("text")
                .attr("class", "tooltiptext")
                .attr("fill", "black")
                .attr("font-family", "sans-serif")
                .attr("font-size", "10px")
                .attr("font-weight", "bold")
                .attr("x", x(d.month_name) + 45)
                .attr("y", (y(d.death) -10))
                .text(`Month: ${d.month_name}`);
            svg.append("text")
                .attr("class", "tooltiptext")
                .attr("fill", "orange")
                .attr("font-family", "sans-serif")
                .attr("font-size", "10px")
                .attr("font-weight", "bold")
                .attr("x", x(d.month_name) + 45)
                .attr("y", (y(d.death)+5))
                .text(`Hospitalized: ${d.hospitalized.toFixed(2)} millions`);
            svg.append("text")
                .attr("class", "tooltiptext")
                .attr("fill", "red")
                .attr("font-family", "sans-serif")
                .attr("font-size", "10px")
                .attr("font-weight", "bold")
                .attr("x", x(d.month_name) + 45)
                .attr("y", (y(d.death)+20))
                .text(`Death: ${d.death.toFixed(2)} millions`);
        }).on("mouseout", function(event, d) {
            d3.select("#tooltip").remove();
            d3.selectAll(".tooltiptext").remove();
        })
        // On click, drill down to the month chart
        .on("click", function(event, d) {
            monthDrillDown(d.month_name);
        });
    
    // Add line for hospitalized
    svg.append("path")
        .datum(data_all)
        .attr("fill", "none")
        .attr("stroke", "orange")
        .attr("stroke-width", 1.5)
        .attr("d", d3.line()
            .x(function(d) { return x(d.month_name) + x.bandwidth()/2 })
            .y(function(d) { return y(d.hospitalized) })
        );
    // Add circle for hospitalized
    svg.selectAll("dot")
        .data(data_all)
        .enter()
        .append("circle")
        .attr("cx", function(d) { return x(d.month_name) + x.bandwidth()/2 })
        .attr("cy", function(d) { return y(d.hospitalized) })
        .attr("r", 6)
        .attr("fill", "orange")
        // Add tooltip when mouse over any circle
        // Tool tip is the sum of positive, hospitalized and death
        // Tool tip is positioned right on top of the circle
        .on("mouseover", function(event, d){
            // Change pointer to hand
            d3.select(this).style("cursor", "pointer");
            svg.append("rect")
                .attr("height", 75)
                .attr("width",145)
                .attr("id", "tooltip")
                .attr("x", x(d.month_name) +40)
                .attr("y", y(d.hospitalized)-30)
                .attr("fill", "white")
                .attr("stroke", "black")
                .attr("stroke-width", 1);
            svg.append("text")
                .attr("class", "tooltiptext")
                .attr("fill", "black")
                .attr("font-family", "sans-serif")
                .attr("font-size", "10px")
                .attr("font-weight", "bold")
                .attr("x", x(d.month_name) + 45)
                .attr("y", (y(d.hospitalized) -10))
                .text(`Month: ${d.month_name}`);
            svg.append("text")
                .attr("class", "tooltiptext")
                .attr("fill", "orange")
                .attr("font-family", "sans-serif")
                .attr("font-size", "10px")
                .attr("font-weight", "bold")
                .attr("x", x(d.month_name) + 45)
                .attr("y", (y(d.hospitalized)+20))
                .text(`Hospitalized: ${d.hospitalized.toFixed(2)} millions`);
            svg.append("text")
                .attr("class", "tooltiptext")
                .attr("fill", "red")
                .attr("font-family", "sans-serif")
                .attr("font-size", "10px")
                .attr("font-weight", "bold")
                .attr("x", x(d.month_name) + 45)
                .attr("y", (y( d.hospitalized)+5))
                .text(`Death: ${d.death.toFixed(2)} millions`);
        }).on("mouseout", function(event, d) {
            d3.select("#tooltip").remove();
            d3.selectAll(".tooltiptext").remove();
        })
         // On click, drill down to the month chart
         .on("click", function(event, d) {
            monthDrillDown(d.month_name);
        });
    // Add an Annotation in between April and May, which is a vertical line
    // On top of the line is a horizontal line
    // On top of the horizontal line is a text
    svg.append("line")
        .attr("x1", x("Mar") + x.bandwidth()/2)
        .attr("y1", y(0))
        .attr("x2",  x("Mar") + x.bandwidth()/2)
        .attr("y2", y(28))
        .attr("stroke-width", 1)
        .attr("stroke", "black");
    svg.append("line")
        .attr("x1",  x("Mar") + x.bandwidth()/2)
        .attr("y1", y(28))
        .attr("x2", x("May") + x.bandwidth()/2 )
        .attr("y2", y(28))
        .attr("stroke-width", 1)
        .attr("stroke", "black");
    svg.append("text")
        .attr("fill", "black")
        .attr("font-family", "sans-serif")
        .attr("font-size", "12px")
        .attr("font-weight", "bold")
        .attr("x",  x("Mar") + x.bandwidth()/2 + 5)
        .attr("y", y(28) - 10)
        .text("Lock-down started");

    svg.append("line")
        .attr("x1", x("May"))
        .attr("y1", y(0))
        .attr("x2",  x("May"))
        .attr("y2", y(26))
        .attr("stroke-width", 1)
        .attr("stroke", "black");
    svg.append("line")
        .attr("x1", x("May"))
        .attr("y1", y(26))
        .attr("x2", x("Sep") + x.bandwidth()/2 )
        .attr("y2", y(26))
        .attr("stroke-width", 1)
        .attr("stroke", "black");
    svg.append("text")
        .attr("fill", "black")
        .attr("font-family", "sans-serif")
        .attr("font-size", "12px")
        .attr("font-weight", "bold")
        .attr("x",  x("May") + 5)
        .attr("y", y(26) - 10)
        .text("All 50 US states reported death cases by April 15");
    
    svg.append("line")
        .attr("x1", x("Jul") + x.bandwidth()/2)
        .attr("y1", y(0))
        .attr("x2", x("Jul") + x.bandwidth()/2)
        .attr("y2", y(24))
        .attr("stroke-width", 1)
        .attr("stroke", "black");
    svg.append("line")
        .attr("x1", x("Jul") + x.bandwidth()/2)
        .attr("y1", y(24))
        .attr("x2", x("Sep") + x.bandwidth()/2 )
        .attr("y2", y(24))
        .attr("stroke-width", 1)
        .attr("stroke", "black");
    svg.append("text")
        .attr("fill", "black")
        .attr("font-family", "sans-serif")
        .attr("font-size", "12px")
        .attr("font-weight", "bold")
        .attr("x",   x("Jul") + x.bandwidth()/2 + 5)
        .attr("y", y(24) - 10)
        .text("Lock-down ended");
  
    // Add legend
    svg.append("circle")
        .attr("r", 6)
        .attr("cx", width - marginRight + 20)
        .attr("cy", marginTop + 20)
        .attr("fill", "red");
    svg.append("text")
        .attr("fill", "black")
        .attr("font-family", "sans-serif")
        .attr("font-size", "10px")
        .attr("font-weight", "bold")
        .attr("x", width - marginRight + 40)
        .attr("y", marginTop + 23)
        .text("Deaths");
    svg.append("circle")
        .attr("r", 6)
        .attr("cx", width - marginRight + 20)
        .attr("cy", marginTop + 40)
        .attr("fill", "orange");
    svg.append("text")
        .attr("fill", "black")
        .attr("font-family", "sans-serif")
        .attr("font-size", "10px")
        .attr("font-weight", "bold")
        .attr("x", width - marginRight + 40)
        .attr("y", marginTop + 43)
        .text("Hospitalized");
    fullYearLowerChart.append(svg.node());
};

function displayMonthChart (input_month_filter) {

    // first empty the byMonthChart
    d3.select("#byMonthChart").selectAll("*").remove();
    let month_filter
    if (!input_month_filter) {
        month_filter = "Jan";
    } else {
        month_filter = input_month_filter;
    }
    // filter data_all by month
    let data_filter = data_states.filter(function(d) {
        return d.month_name === month_filter;
    });
    // sort data_filter by total number of positive, hospitalized and death
    data_filter.sort(function(a, b) {
        return (a.positive + a.hospitalized + a.death) - (b.positive + b.hospitalized + b.death);
    });
    console.log('sorted month data', data_filter);
    // Get all sorted state names
    const sorted_states = data_filter.map(d => d.state_name);
    // Declare the x (horizontal position) scale.

    const x = d3.scaleBand()
        .domain(sorted_states)
        .range([marginLeft, width - marginRight]);
    // Find y_max by finding the max of positive, hospitalized and death
    const y_max = d3.max(data_filter, function(d) {
        return d.positive + d.hospitalized + d.death;
    });
    // Declare the y (vertical position) scale.
    const y = d3.scaleLinear()
        .domain([0, y_max])
        .range([height - marginBottom, marginTop]);

    // Create the SVG container.
    const svg = d3.create("svg")
        .attr("width", width)
        .attr("height", height);

    // Add the x-axis, with text rotated 90 degree
    svg.append("g")
        .attr("transform", `translate(0,${height - marginBottom})`)

        .call(d3.axisBottom(x))
        .selectAll("text")
        .attr("transform", "rotate(-90)")
        .attr("x",-10)
        .attr("y", 0)
        .attr("dy", ".35em")
        .style("text-anchor", "end");

    // Add x-axis label
    svg.append("text")
        .attr("class", "x label")
        .attr("text-anchor", "end")
        .attr("x", width - marginRight + 40)
        .attr("y", height - marginBottom + 20)
        .attr("font-size", "15px")
        .text("State");

    // Add the y-axis.
    svg.append("g")
        .attr("transform", `translate(${marginLeft},0)`)
        .call(d3.axisLeft(y));
    // Add y-axis label
    svg.append("text")
        .attr("class", "y label")
        .attr("text-anchor", "end")
        .attr("x", -(height/3))
        .attr("y", marginLeft - 50)
        .attr("font-size", "15px")
        .attr("transform", "rotate(-90)")
        .text("Number of cases (millions)");
    
    // Add the bars, one for each month, the bar height is the number of positive for that month
    svg.append("g")
        .attr("fill", "steelblue")
        .selectAll("rect")
        .data(data_filter)
        .join("rect")
        .attr("x", d => x(d.state_name) + x.bandwidth() * 1 / 6)
        .attr("y", d => y(d.positive))
        .attr("height", d => {
            if (d.positive) {
                return y(0) - y(d.positive)
            } else {
                return 0;
            }
        })
        .attr("width", x.bandwidth() * 2 / 3)
        // Add tooltip when mouse over any bar
        // Tool tip is the sum of positive, hospitalized and death
        // Tool tip is positioned right on top of the bar
        .on("mouseover", function(event, d) {
            // Change pointer to hand
            d3.select(this).style("cursor", "pointer");
            svg.append("rect")
                .attr("height", 40)
                .attr("width",135)
                .attr("id", "tooltip")
                .attr("x", x(d.state_name) + x.bandwidth()/3 - 10)
                .attr("y", (y(d.death + d.hospitalized + d.positive) - 43))
                .attr("fill", "white")
                .attr("stroke", "black")
                .attr("stroke-width", 1);
            svg.append("text")
                .attr("class", "tooltiptext")
                .attr("fill", "black")
                .attr("font-family", "sans-serif")
                .attr("font-size", "10px")
                .attr("font-weight", "bold")
                .attr("x", x(d.state_name) + x.bandwidth()/3)
                .attr("y", (y(d.death + d.hospitalized + d.positive) - 25))
                // Add the sum of positive, hospitalized and death
                .text(`State: ${d.state_name}`);
            svg.append("text")
                .attr("class", "tooltiptext")
                .attr("fill", "steelblue")
                .attr("font-family", "sans-serif")
                .attr("font-size", "10px")
                .attr("font-weight", "bold")
                .attr("x", x(d.state_name) + x.bandwidth()/3)
                .attr("y", (y(d.death + d.hospitalized + d.positive) - 10))
                // Add the sum of positive, hospitalized and death
                .text(`Positive: ${d.positive.toFixed(2)} millions`);
        }).on("mouseout", function(event, d) {
            d3.select("#tooltip").remove();
            d3.selectAll(".tooltiptext").remove();
        })
        // On click, drill down to the state chart
        .on("click", function(event, d) {
            stateDrillDown(d.state_name);
        });
    // Add another bar positioned right on top of the positive bar, the bar height is the number of hospitalized for that month
    svg.append("g")
        .attr("fill", "orange")
        .selectAll("rect")
        .data(data_filter)
        .join("rect")
        .attr("x", d => x(d.state_name) + x.bandwidth() * 1 / 6)
        .attr("y", d => y(d.hospitalized + d.positive))
        .attr("height", d => {
            if (d.hospitalized) {
                return y(0) - y(d.hospitalized)
            } else {
                return 0;
            }
        })
        // set width to the bandwidth of the x scale, but reduced by 1/3
        .attr("width", x.bandwidth() * 2 / 3)
        // Add tooltip when mouse over any bar
        // Tool tip is the sum of positive, hospitalized and death
        // Tool tip is positioned right on top of the bar
        .on("mouseover", function(event, d) {
            // Change pointer to hand
            d3.select(this).style("cursor", "pointer");
            svg.append("rect")
                .attr("height", 40)
                .attr("width",150)
                .attr("id", "tooltip")
                .attr("x", x(d.state_name) + x.bandwidth()/3 - 10)
                .attr("y", (y(d.death + d.hospitalized + d.positive) - 43))
                .attr("fill", "white")
                .attr("stroke", "black")
                .attr("stroke-width", 1);
            svg.append("text")
                .attr("class", "tooltiptext")
                .attr("fill", "black")
                .attr("font-family", "sans-serif")
                .attr("font-size", "10px")
                .attr("font-weight", "bold")
                .attr("x", x(d.state_name) + x.bandwidth()/3)
                .attr("y", (y(d.death + d.hospitalized + d.positive) - 25))
                // Add the sum of positive, hospitalized and death
                .text(`State: ${d.state_name}`);
            svg.append("text")
                .attr("class", "tooltiptext")
                .attr("fill", "orange")
                .attr("font-family", "sans-serif")
                .attr("font-size", "10px")
                .attr("font-weight", "bold")
                .attr("x", x(d.state_name) + x.bandwidth()/3)
                .attr("y", (y(d.death + d.hospitalized + d.positive) - 10))
                // Add the sum of positive, hospitalized and death
                .text(`Hospitalized: ${d.hospitalized.toFixed(2)} millions`);
        }).on("mouseout", function(event, d) {
            d3.select("#tooltip").remove();
            d3.selectAll(".tooltiptext").remove();
        })
        // On click, drill down to the state chart
        .on("click", function(event, d) {
            stateDrillDown(d.state_name);
        });
    // Add another bar positioned right on top of the hospitalized bar, the bar height is the number of death for that month
    svg.append("g")
        .attr("fill", "red")
        .selectAll("rect")
        .data(data_filter)
        .join("rect")
        .attr("x", d => x(d.state_name) + x.bandwidth() * 1 / 6)
        .attr("y", d => y(d.death + d.hospitalized + d.positive))
        .attr("height", d => {
            if (d.death) {
                return y(0) - y(d.death)
            } else {
                return 0;
            }
        })
        .attr("width", x.bandwidth() * 2 / 3)
        // Add tooltip when mouse over any bar
        // Tool tip is the sum of positive, hospitalized and death
        // Tool tip is positioned right on top of the bar
        .on("mouseover", function(event, d) {
            // Change pointer to hand
            d3.select(this).style("cursor", "pointer");
            svg.append("rect")
                .attr("height", 40)
                .attr("width",130)
                .attr("id", "tooltip")
                .attr("x", x(d.state_name) + x.bandwidth()/3 - 10)
                .attr("y", (y(d.death + d.hospitalized + d.positive) - 43))
                .attr("fill", "white")
                .attr("stroke", "black")
                .attr("stroke-width", 1);
            svg.append("text")
                .attr("class", "tooltiptext")
                .attr("fill", "black")
                .attr("font-family", "sans-serif")
                .attr("font-size", "10px")
                .attr("font-weight", "bold")
                .attr("x", x(d.state_name) + x.bandwidth()/3)
                .attr("y", (y(d.death + d.hospitalized + d.positive) - 25))
                // Add the sum of positive, hospitalized and death
                .text(`State: ${d.state_name}`);
            svg.append("text")
                .attr("class", "tooltiptext")
                .attr("fill", "red")
                .attr("font-family", "sans-serif")
                .attr("font-size", "10px")
                .attr("font-weight", "bold")
                .attr("x", x(d.state_name) + x.bandwidth()/3)
                .attr("y", (y(d.death + d.hospitalized + d.positive) - 10))
                // Add the sum of positive, hospitalized and death
                .text(`Deaths: ${d.death.toFixed(2)} millions`);
        }).on("mouseout", function(event, d) {
            d3.select("#tooltip").remove();
            d3.selectAll(".tooltiptext").remove();
        })
        // On click, drill down to the state chart
        .on("click", function(event, d) {
            stateDrillDown(d.state_name);
        });
    // Add legend
    svg.append("rect")
        .attr("height", 20)
        .attr("width", 20)
        .attr("x", width - marginRight + 20)
        .attr("y", marginTop + 20)
        .attr("fill", "red");
    svg.append("text")
        .attr("class", "legend")
        .attr("fill", "black")
        .attr("font-family", "sans-serif")
        .attr("font-size", "10px")
        .attr("font-weight", "bold")
        .attr("x", width - marginRight + 50)
        .attr("y", marginTop + 35)
        .text("Deaths");
    svg.append("rect")
        .attr("height", 20)
        .attr("width", 20)
        .attr("x", width - marginRight + 20)
        .attr("y", marginTop + 50)
        .attr("fill", "orange");
    svg.append("text")
        .attr("class", "legend")
        .attr("fill", "black")
        .attr("font-family", "sans-serif")
        .attr("font-size", "10px")
        .attr("font-weight", "bold")
        .attr("x", width - marginRight + 50)
        .attr("y", marginTop + 65)
        .text("Hospitalized");
        svg.append("rect")
        .attr("height", 20)
        .attr("width", 20)
        .attr("x", width - marginRight + 20)
        .attr("y", marginTop + 80)
        .attr("fill", "steelblue");
    svg.append("text")
        .attr("class", "legend")
        .attr("fill", "black")
        .attr("font-family", "sans-serif")
        .attr("font-size", "10px")
        .attr("font-weight", "bold")
        .attr("x", width - marginRight + 50)
        .attr("y", marginTop + 95)
        .text("Positive");
    
    byMonthChart.append(svg.node());
    
};


function displayStateChart (input_state_filter) {
    // const all_states = [...new Set(data_states.map(d => d.state_name))];
    // console.log('all_states', all_states);

    // first empty the byStateChart
    d3.select("#byStateChart").selectAll("*").remove();
    let state_filter = input_state_filter;
    // Default state is Alaska
    if (!state_filter) {
        state_filter = "Alaska";
    }
    let data_filter = data_states.filter(function(d) {
        return d.state_name == state_filter;
    });
    console.log(data_states);

    
    // Declare the x (horizontal position) scale.
    const x = d3.scaleBand()
        .domain(months)
        .range([marginLeft, width - marginRight]);
    // Find the max sum of positive, hospitalized and death
    const data_y_max = d3.max(data_filter, function(d) {
        return d.positive + d.hospitalized + d.death;
    });
    const y_max = data_y_max;
    // Declare the y (vertical position) scale.
    const y = d3.scaleLinear()
        .domain([0, y_max])
        .range([height - marginBottom, marginTop]);

    // Create the SVG container.
    const svg = d3.create("svg")
        .attr("width", width)
        .attr("height", height);

    // Add the x-axis.
    svg.append("g")
        .attr("transform", `translate(0,${height - marginBottom})`)
        .call(d3.axisBottom(x));
    // Add x-axis label
    svg.append("text")
        .attr("class", "x label")
        .attr("text-anchor", "end")
        .attr("x", (width - marginRight)/2 + 50)
        .attr("y", height - marginBottom + 40)
        .attr("font-size", "15px")
        .text("Month");

    // Add the y-axis.
    svg.append("g")
        .attr("transform", `translate(${marginLeft},0)`)
        .call(d3.axisLeft(y));
    // Add y-axis label
    svg.append("text")
        .attr("class", "y label")
        .attr("text-anchor", "end")
        .attr("x", -(height/3))
        .attr("y", marginLeft - 50)
        .attr("font-size", "15px")
        .attr("transform", "rotate(-90)")
        .text("Number of cases (millions)");

    // Add the bars, one for each month, the bar height is the number of positive for that month
    svg.append("g")
        .attr("fill", "steelblue")
        .selectAll("rect")
        .data(data_filter)
        .join("rect")
        .attr("x", d => x(d.month_name) + x.bandwidth() * 1 / 6)
        .attr("y", d => y(d.positive))
        .attr("height", d => {
            if (d.positive) {
                return y(0) - y(d.positive)
            } else {
                return 0;
            }
        })
        .attr("width", x.bandwidth() * 2 / 3)
        // Add tooltip when mouse over any bar
        // Tool tip is the sum of positive, hospitalized and death
        // Tool tip is positioned right on top of the bar
        .on("mouseover", function(event, d) {
            // Change pointer to hand
            d3.select(this).style("cursor", "pointer");
            svg.append("rect")
                .attr("height", 40)
                .attr("width",135)
                .attr("id", "tooltip")
                .attr("x", x(d.month_name) + x.bandwidth()/3 - 10)
                .attr("y", (y(d.death + d.hospitalized + d.positive) - 43))
                .attr("fill", "white")
                .attr("stroke", "black")
                .attr("stroke-width", 1);
            svg.append("text")
                .attr("class", "tooltiptext")
                .attr("fill", "black")
                .attr("font-family", "sans-serif")
                .attr("font-size", "10px")
                .attr("font-weight", "bold")
                .attr("x", x(d.month_name) + x.bandwidth()/3)
                .attr("y", (y(d.death + d.hospitalized + d.positive) - 25))
                // Add the sum of positive, hospitalized and death
                .text(`Month: ${d.month_name}`);
            svg.append("text")
                .attr("class", "tooltiptext")
                .attr("fill", "steelblue")
                .attr("font-family", "sans-serif")
                .attr("font-size", "10px")
                .attr("font-weight", "bold")
                .attr("x", x(d.month_name) + x.bandwidth()/3)
                .attr("y", (y(d.death + d.hospitalized + d.positive) - 10))
                // Add the sum of positive, hospitalized and death
                .text(`Positive: ${d.positive.toFixed(2)} millions`);
        }).on("mouseout", function(event, d) {
            d3.select("#tooltip").remove();
            d3.selectAll(".tooltiptext").remove();
        })
        .on("click", function(event, d) {
            monthStateDrillDown(d.month_name, d.state_name);
        });
    // Add another bar positioned right on top of the positive bar, the bar height is the number of hospitalized for that month
    svg.append("g")
        .attr("fill", "orange")
        .selectAll("rect")
        .data(data_filter)
        .join("rect")
        .attr("x", d => x(d.month_name) + x.bandwidth() * 1 / 6)
        .attr("y", d => y(d.hospitalized + d.positive))
        .attr("height", d => {
            if (d.hospitalized) {
                return y(0) - y(d.hospitalized)
            } else {
                return 0;
            }
        })
        // set width to the bandwidth of the x scale, but reduced by 1/3
        .attr("width", x.bandwidth() * 2 / 3)
        // Add tooltip when mouse over any bar
        // Tool tip is the sum of positive, hospitalized and death
        // Tool tip is positioned right on top of the bar
        .on("mouseover", function(event, d) {
            // Change pointer to hand
            d3.select(this).style("cursor", "pointer");
            svg.append("rect")
                .attr("height", 40)
                .attr("width",150)
                .attr("id", "tooltip")
                .attr("x", x(d.month_name) + x.bandwidth()/3 - 10)
                .attr("y", (y(d.death + d.hospitalized + d.positive) - 43))
                .attr("fill", "white")
                .attr("stroke", "black")
                .attr("stroke-width", 1);
            svg.append("text")
                .attr("class", "tooltiptext")
                .attr("fill", "black")
                .attr("font-family", "sans-serif")
                .attr("font-size", "10px")
                .attr("font-weight", "bold")
                .attr("x", x(d.month_name) + x.bandwidth()/3)
                .attr("y", (y(d.death + d.hospitalized + d.positive) - 25))
                // Add the sum of positive, hospitalized and death
                .text(`Month: ${d.month_name}`);
            svg.append("text")
                .attr("class", "tooltiptext")
                .attr("fill", "orange")
                .attr("font-family", "sans-serif")
                .attr("font-size", "10px")
                .attr("font-weight", "bold")
                .attr("x", x(d.month_name) + x.bandwidth()/3)
                .attr("y", (y(d.death + d.hospitalized + d.positive) - 10))
                // Add the sum of positive, hospitalized and death
                .text(`Hospitalized: ${d.hospitalized.toFixed(2)} millions`);
        }).on("mouseout", function(event, d) {
            d3.select("#tooltip").remove();
            d3.selectAll(".tooltiptext").remove();
        })
        .on("click", function(event, d) {
            monthStateDrillDown(d.month_name, d.state_name);
        });
    // Add another bar positioned right on top of the hospitalized bar, the bar height is the number of death for that month
    svg.append("g")
        .attr("fill", "red")
        .selectAll("rect")
        .data(data_filter)
        .join("rect")
        .attr("x", d => x(d.month_name) + x.bandwidth() * 1 / 6)
        .attr("y", d => y(d.death + d.hospitalized + d.positive))
        .attr("height", d => {
            if (d.death) {
                return y(0) - y(d.death)
            } else {
                return 0;
            }
        })
        .attr("width", x.bandwidth() * 2 / 3)
        // Add tooltip when mouse over any bar
        // Tool tip is the sum of positive, hospitalized and death
        // Tool tip is positioned right on top of the bar
        .on("mouseover", function(event, d) {
            // Change pointer to hand
            d3.select(this).style("cursor", "pointer");
            svg.append("rect")
                .attr("height", 40)
                .attr("width",130)
                .attr("id", "tooltip")
                .attr("x", x(d.month_name) + x.bandwidth()/3 - 10)
                .attr("y", (y(d.death + d.hospitalized + d.positive) - 43))
                .attr("fill", "white")
                .attr("stroke", "black")
                .attr("stroke-width", 1);
            svg.append("text")
                .attr("class", "tooltiptext")
                .attr("fill", "black")
                .attr("font-family", "sans-serif")
                .attr("font-size", "10px")
                .attr("font-weight", "bold")
                .attr("x", x(d.month_name) + x.bandwidth()/3)
                .attr("y", (y(d.death + d.hospitalized + d.positive) - 25))
                // Add the sum of positive, hospitalized and death
                .text(`Month: ${d.month_name}`);
            svg.append("text")
                .attr("class", "tooltiptext")
                .attr("fill", "red")
                .attr("font-family", "sans-serif")
                .attr("font-size", "10px")
                .attr("font-weight", "bold")
                .attr("x", x(d.month_name) + x.bandwidth()/3)
                .attr("y", (y(d.death + d.hospitalized + d.positive) - 10))
                // Add the sum of positive, hospitalized and death
                .text(`Deaths: ${d.death.toFixed(2)} millions`);
        }).on("mouseout", function(event, d) {
            d3.select("#tooltip").remove();
            d3.selectAll(".tooltiptext").remove();
        })
        .on("click", function(event, d) {
            monthStateDrillDown(d.month_name, d.state_name);
        });
    // Add annotation
    // Add an Annotation in between April and May, which is a vertical line
    // On top of the line is a horizontal line
    // On top of the horizontal line is a text
    const y_top = y(y_max*0.95)
    const y_mid = y(y_max*0.85)
    const y_bottom = y(y_max*0.75) 
    svg.append("line")
        .attr("x1", x("Mar") + x.bandwidth()/2)
        .attr("y1", y(0))
        .attr("x2",  x("Mar") + x.bandwidth()/2)
        .attr("y2", y_top)
        .attr("stroke-width", 1)
        .attr("stroke", "black");
    svg.append("line")
        .attr("x1",  x("Mar") + x.bandwidth()/2)
        .attr("y1", y_top)
        .attr("x2", x("May") + x.bandwidth()/2 )
        .attr("y2", y_top)
        .attr("stroke-width", 1)
        .attr("stroke", "black");
    svg.append("text")
        .attr("fill", "black")
        .attr("font-family", "sans-serif")
        .attr("font-size", "12px")
        .attr("font-weight", "bold")
        .attr("x",  x("Mar") + x.bandwidth()/2 + 5)
        .attr("y", y_top - 10)
        .text("Lock-down started");

    svg.append("line")
        .attr("x1", x("May"))
        .attr("y1", y(0))
        .attr("x2",  x("May"))
        .attr("y2",  y_mid)
        .attr("stroke-width", 1)
        .attr("stroke", "black");
    svg.append("line")
        .attr("x1", x("May"))
        .attr("y1",  y_mid)
        .attr("x2", x("Sep") + x.bandwidth()/2 )
        .attr("y2",  y_mid)
        .attr("stroke-width", 1)
        .attr("stroke", "black");
    svg.append("text")
        .attr("fill", "black")
        .attr("font-family", "sans-serif")
        .attr("font-size", "12px")
        .attr("font-weight", "bold")
        .attr("x",  x("May") + 5)
        .attr("y",  y_mid - 10)
        .text("All 50 US states reported death cases by April 15");
    
    svg.append("line")
        .attr("x1", x("Jul") + x.bandwidth()/2)
        .attr("y1", y(0))
        .attr("x2", x("Jul") + x.bandwidth()/2)
        .attr("y2", y_bottom)
        .attr("stroke-width", 1)
        .attr("stroke", "black");
    svg.append("line")
        .attr("x1", x("Jul") + x.bandwidth()/2)
        .attr("y1", y_bottom)
        .attr("x2", x("Sep") + x.bandwidth()/2 )
        .attr("y2", y_bottom)
        .attr("stroke-width", 1)
        .attr("stroke", "black");
    svg.append("text")
        .attr("fill", "black")
        .attr("font-family", "sans-serif")
        .attr("font-size", "12px")
        .attr("font-weight", "bold")
        .attr("x",   x("Jul") + x.bandwidth()/2 + 5)
        .attr("y", y_bottom - 10)
        .text("Lock-down ended");
    
    // Add legend
    svg.append("rect")
        .attr("height", 20)
        .attr("width", 20)
        .attr("x", width - marginRight + 20)
        .attr("y", marginTop + 20)
        .attr("fill", "red");
    svg.append("text")
        .attr("class", "legend")
        .attr("fill", "black")
        .attr("font-family", "sans-serif")
        .attr("font-size", "10px")
        .attr("font-weight", "bold")
        .attr("x", width - marginRight + 50)
        .attr("y", marginTop + 35)
        .text("Deaths");
    svg.append("rect")
        .attr("height", 20)
        .attr("width", 20)
        .attr("x", width - marginRight + 20)
        .attr("y", marginTop + 50)
        .attr("fill", "orange");
    svg.append("text")
        .attr("class", "legend")
        .attr("fill", "black")
        .attr("font-family", "sans-serif")
        .attr("font-size", "10px")
        .attr("font-weight", "bold")
        .attr("x", width - marginRight + 50)
        .attr("y", marginTop + 65)
        .text("Hospitalized");
        svg.append("rect")
        .attr("height", 20)
        .attr("width", 20)
        .attr("x", width - marginRight + 20)
        .attr("y", marginTop + 80)
        .attr("fill", "steelblue");
    svg.append("text")
        .attr("class", "legend")
        .attr("fill", "black")
        .attr("font-family", "sans-serif")
        .attr("font-size", "10px")
        .attr("font-weight", "bold")
        .attr("x", width - marginRight + 50)
        .attr("y", marginTop + 95)
        .text("Positive");

    // Append the SVG element.
    byStateChart.append(svg.node());
};


function displayMonthStateChart (input_month_filter, input_state_filter) {

// first empty the byStateChart
d3.select("#byMonthStateChart").selectAll("*").remove();
    let state_filter = input_state_filter;
    // Default state is Alaska
    if (!state_filter) {
        state_filter = "Alaska";
    }
    let month_filter = input_month_filter;
    // Default month is Jan
    if (!month_filter) {
        month_filter = "Jan";
    }
    console.log('selected month', month_filter);
    console.log('selected state', state_filter);
    // Copy the data_states
    const data_states_copy = JSON.parse(JSON.stringify(data_states));
    let data_filter = data_states_copy.filter(function(d) {
        return d.state_name === state_filter;
    });
    // filter data_filter by month
    data_filter = data_filter.filter(function(d) {
        return d.month_name === month_filter;
    });
    let data_sum = 0;
    for (const [key, value] of Object.entries(data_filter[0] || {})) {
        if (key !== "month_name" && key !== "state_name") {
            data_sum += value;
        }
    }
    if ((data_filter.length) === 0 || data_sum === 0) {
        // No data for the selected month and state
        // Display a text saying No data found for this month and state
            // Create the SVG container.
        const svg = d3.create("svg")
            .attr("width", width)
            .attr("height", height);
        svg.append("text")
            .attr("class", "noData")
            .attr("fill", "black")
            .attr("font-family", "sans-serif")
            .attr("font-size", "17px")
            .attr("font-weight", "bold")
            .attr("x", (width/2)-250)
            .attr("y", height/3)
            .text(`No data found for state ${state_filter} in month ${month_filter}`);
        byMonthStateChart.append(svg.node());
        return;
    }

    // remove the month_name and state_name from the data_filter
    delete data_filter[0].month_name;
    delete data_filter[0].state_name;

    data_filter = data_filter[0];

    

    console.log('month state data', data_filter);

    // Create the SVG container.
    const svg = d3.create("svg")
        .attr("width", width)
        .attr("height", height);

    const color = {
        "positive": "steelblue",
        "hospitalized": "orange",
        "death": "red"
    }

    console.log('color', color);

    // Create a pie chart for the data_filter
    // The pie chart is centered at (width/2, height/2)
    // The radius of the pie chart is 100
    const pie = d3.pie()
        .value(function(d) {return d.value; })
        .sort(null);
    const data_entries = []
    for (const [key, value] of Object.entries(data_filter)) {
        const current_entry = {}
        current_entry["key"] = key;
        current_entry["value"] = value;
        data_entries.push(current_entry);
    }   
    console.log('data_entries', data_entries)
    const data_ready = pie(data_entries);
    console.log('data_ready', data_ready);
    svg
    .selectAll('whatever')
    .data(data_ready)
    .enter()
    .append('path')
    .attr('d', d3.arc()
        .innerRadius(0)
        .outerRadius(170)
    )
    .attr('fill', function(d){ return(color[d.data.key]) })
    // .attr("stroke", "black")
    // .style("stroke-width", "2px")
    .style("opacity", 1)
    // Bring it to the center of the svg
    .attr("transform", "translate(" + width/2 + "," + height/2 + ")")
    // Add annotation to the pie chart for death, hospitalized and positive
    // The annotation value is the value of death, hospitalized and positive
    // The annotation is positioned out side, right next to the pie chart
    .on("mouseover", function(event, d) {
        // Change pointer to hand
        d3.select(this).attr("stroke", "black").style("stroke-width", "2px");
        svg.append("rect")
            .attr("height", 35)
            .attr("width",190)
            .attr("id", "tooltip")
            .attr("x", width/2 - 90)
            .attr("y", height/7)
            .attr("fill", "white")
            .attr("stroke", "black")
            .attr("stroke-width", 1);
        svg.append("text")
            .attr("class", "tooltiptext")
            .attr("fill", color[d.data.key])
            .attr("font-family", "sans-serif")
            .attr("font-size", "10px")
            .attr("font-weight", "bold")
            .attr("x", width/2 - 80)
            .attr("y", height/7 + 20)
            // Add the sum of positive, hospitalized and death, capitialize the first letter
            .text(`${d.data.key[0].toUpperCase() + d.data.key.slice(1)}: ${d.data.value.toFixed(2)} millions (${(d.data.value/data_sum*100).toFixed(2)}%)`);
    }).on("mouseout", function(event, d) {
        // no stroke
        d3.select(this).attr("stroke", "none");
        d3.select("#tooltip").remove();
        d3.selectAll(".tooltiptext").remove();
    });
    // Add legend
    svg.append("rect")
        .attr("height", 20)
        .attr("width", 20)
        .attr("x", width - marginRight + 20)
        .attr("y", marginTop + 20)
        .attr("fill", "red");
    svg.append("text")
        .attr("class", "legend")
        .attr("fill", "black")
        .attr("font-family", "sans-serif")
        .attr("font-size", "10px")
        .attr("font-weight", "bold")
        .attr("x", width - marginRight + 50)
        .attr("y", marginTop + 35)
        .text("Deaths");
    svg.append("rect")
        .attr("height", 20)
        .attr("width", 20)
        .attr("x", width - marginRight + 20)
        .attr("y", marginTop + 50)
        .attr("fill", "orange");
    svg.append("text")
        .attr("class", "legend")
        .attr("fill", "black")
        .attr("font-family", "sans-serif")
        .attr("font-size", "10px")
        .attr("font-weight", "bold")
        .attr("x", width - marginRight + 50)
        .attr("y", marginTop + 65)
        .text("Hospitalized");
    svg.append("rect")
        .attr("height", 20)
        .attr("width", 20)
        .attr("x", width - marginRight + 20)
        .attr("y", marginTop + 80)
        .attr("fill", "steelblue");
    svg.append("text")
        .attr("class", "legend")
        .attr("fill", "black")
        .attr("font-family", "sans-serif")
        .attr("font-size", "10px")
        .attr("font-weight", "bold")
        .attr("x", width - marginRight + 50)
        .attr("y", marginTop + 95)
        .text("Positive");

    // Append the SVG element.
    byMonthStateChart.append(svg.node());
};

</script>